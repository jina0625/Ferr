<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.warr.ferr.mapper.ChatMapper">

	<resultMap type="com.warr.ferr.model.ChatroomMembers" id="ChatroomMembers">
 		<result property="chatroomId" column="chatroom_id"/>
 		<result property="userId" column="user_id"/>
 		<result property="chatroomName" column="chatroom_name"/>
 		<result property="status" column="status"/>
 		<result property="lastReadAt" column="last_read_at"/>
 	</resultMap>
 	
	<!-- 모든 채팅방 리스트. 채팅방 생성시 사용 -->
	<select id="findAllRooms"
			resultType="com.warr.ferr.model.Chatrooms">
		SELECT chatroom_id as chatroomId, name
		FROM chatrooms
	</select>
	
	<!-- userid 기준 리스트조회 -->
	<select id="findAllRoomsByUserId"
			parameterType="int"
			resultMap="ChatroomMembers">
		SELECT chatroom_id, user_id, chatroom_name, status, last_read_at
		FROM chatroom_members
		WHERE user_id = #{userId} AND status = 'JOIN'
	</select>
	
	<!-- 유저id로 채팅방 찾아들어갈때 -->
	<select id="findRoomById"
			parameterType="int"
			resultMap="ChatroomMembers">
		SELECT chatroom_id, user_id, chatroom_name, status
		FROM chatroom_members 
		WHERE chatroom_id = #{chatroomId} AND user_id = #{userId}
	</select>
	
	<!-- 중복검사용 리스트 -->
	<select id="findRoomByUserIdByChatroomId"
			parameterType="int"
			resultMap="ChatroomMembers">
		SELECT s.chatroom_id, s.user_id
		FROM chatroom_members s
		WHERE s.status = 'JOIN' AND s.chatroom_id IN (SELECT f.chatroom_id
													FROM chatroom_members f
							                        WHERE f.user_id = #{userId});
	</select>
	
	
	<!-- chatroomId 생성 -->
	<insert id="createRoomId"
			parameterType="com.warr.ferr.model.ChatroomMembers"
			useGeneratedKeys="true"
			keyColumn="chatroom_id"
			keyProperty="chatroomId">
		INSERT INTO chatrooms (name) VALUE (#{name})	
	</insert>
	
	<!-- chatroom members 구성원 -->
	<insert id="createRoom" parameterType="java.util.List">
	    INSERT INTO chatroom_members (chatroom_id, chatroom_name, user_id, status)
	    VALUES
	    <foreach collection="chatroomMembers" item="chatroomMember" separator=",">
	        (#{chatroomMember.chatroomId}, #{chatroomMember.chatroomName}, #{chatroomMember.userId}, 'JOIN')
	    </foreach>
	</insert>
		
	<!-- 제목 수정 -->
	<!-- <update id="roomNameUpdate"
			parameterType="com.warr.ferr.model.ChatroomMembers">
		UPDATE chatroom_members
		SET chatroom_name = #{chatroomName}
		WHERE chatroom_id = #{chatroomId};
	</update> -->
		
	<!-- 방 삭제 -->
	<!-- <delete id="deleteRoom"
			parameterType="_int">
		delete from Chatroom_members
		where #{roomId} = chatroom_id;
	</delete> -->
	
	
	
</mapper>